<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aulas Sequenciais - CodeLogic</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/code_logic.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='aulas/aulas.css') }}">
    
    <!-- Sobrescrever estilo da tela de carregamento para combinar com outros m√≥dulos -->
    <style>
        .loading-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        .loading-content {
            color: white !important;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3) !important;
            border-top: 4px solid white !important;
        }
    </style>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { firebaseConfig } from "/static/js/firebase-config.js";

        console.log("Inicializando Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        console.log("Firebase inicializado");

        let userLoaded = false;
        let redirectTimeout = null;

        // Fun√ß√£o para cancelar redirecionamento se usu√°rio for encontrado
        function cancelRedirect() {
            if (redirectTimeout) {
                clearTimeout(redirectTimeout);
                redirectTimeout = null;
                console.log("Redirecionamento cancelado - usu√°rio encontrado");
            }
        }

        // Debug: verifica localStorage
        console.log("üîç Estado do localStorage:");
        console.log("- userName:", localStorage.getItem("userName"));
        console.log("- userId:", localStorage.getItem("userId"));
        
        // Fun√ß√£o para verificar autentica√ß√£o de forma mais robusta
        async function verifyAuth() {
            console.log("üîç Verificando autentica√ß√£o...");
            
            // PRIMEIRO: Verifica se h√° dados salvos
            const savedUserName = localStorage.getItem("userName");
            const savedUserId = localStorage.getItem("userId");
            
            if (!savedUserName || !savedUserId) {
                console.log("‚ùå Dados de usu√°rio n√£o encontrados no localStorage");
                alert("Sua sess√£o expirou. Fa√ßa login novamente.");
                window.location.href = "/";
                return;
            }
            
            console.log("üì± Dados salvos encontrados:", savedUserName, "ID:", savedUserId);
            
            // SEGUNDO: Verifica v√°rias vezes se o Firebase Auth detecta o usu√°rio
            let attempts = 0;
            const maxAttempts = 8; // 4 segundos total
            
            const checkInterval = setInterval(() => {
                attempts++;
                console.log(`üîç Tentativa ${attempts}/${maxAttempts} - Verificando Firebase Auth...`);
                
                const user = auth.currentUser;
                if (user) {
                    console.log("‚úÖ Firebase Auth OK - Usu√°rio:", user.uid);
                    clearInterval(checkInterval);
                    cancelRedirect();
                    
                    if (!userLoaded) {
                        userLoaded = true;
                        loadUserProgress(user.uid);
                    }
                    return;
                }
                
                if (attempts >= maxAttempts) {
                    console.log("‚ö†Ô∏è Firebase Auth n√£o funcionou - usando fallback");
                    clearInterval(checkInterval);
                    
                    // TERCEIRO: Usa dados salvos como fallback
                    console.log("üö® Carregando com dados salvos...");
                    cancelRedirect();
                    loadUserProgressFallback(savedUserId, savedUserName);
                }
            }, 500); // Verifica a cada 500ms
        }
        
        // Fun√ß√£o fallback para carregar dados quando Firebase Auth falha
        async function loadUserProgressFallback(userId, userName) {
            try {
                console.log("üìä Carregando progresso via fallback para:", userName);
                
                // Tenta carregar progresso via API
                const response = await fetch('/api/get-progress/' + userId + '/sequencial');
                if (response.ok) {
                    const data = await response.json();
                    console.log("‚úÖ Progresso carregado:", data);
                    
                    const completedLessons = data.aulas_concluidas || [];
                    const liberatedLessons = data.aulas_liberadas || [1];
                    
                    updateLessonStates(completedLessons, liberatedLessons);
                    updateProgressBar(completedLessons.length, completedLessons.length, 10);
                    showContent();
                } else {
                    console.log("‚ö†Ô∏è API n√£o dispon√≠vel - carregando interface b√°sica");
                    // Carrega interface b√°sica mesmo sem progresso
                    updateLessonStates([], [1]); // Primeira aula dispon√≠vel
                    updateProgressBar(0, 0, 10);
                    showContent();
                }
            } catch (error) {
                console.log("‚ùå Erro no fallback:", error);
                // Carrega interface b√°sica mesmo com erro
                updateLessonStates([], [1]);
                updateProgressBar(0, 0, 10);
                showContent();
            }
        }

        // Configura√ß√£o de timeout de seguran√ßa (mais longo)
        function setupSafetyTimeout() {
            redirectTimeout = setTimeout(() => {
                if (!userLoaded && !auth.currentUser) {
                    console.log("‚è∞ Timeout de seguran√ßa - redirecionando");
                    window.location.href = "/";
                }
            }, 8000); // 8 segundos de toler√¢ncia total
        }

        // Quando a p√°gina carrega
        window.addEventListener('load', () => {
            console.log("P√°gina carregada");
            
            // Verifica se h√° dados de usu√°rio salvos como fallback
            const savedUserName = localStorage.getItem("userName");
            if (savedUserName) {
                console.log("üìù Dados de usu√°rio salvos encontrados:", savedUserName);
                // Se h√° dados salvos, d√° mais tempo para o Firebase
                setupSafetyTimeout();
            } else {
                console.log("‚ùå Nenhum dado de usu√°rio salvo");
                // Se n√£o h√° dados salvos, redirecionamento mais r√°pido
                redirectTimeout = setTimeout(() => {
                    if (!userLoaded) {
                        console.log("‚è∞ Sem dados salvos - redirecionando");
                        window.location.href = "/";
                    }
                }, 3000); // 3 segundos se n√£o h√° dados
            }
            
            // Aguarda um pouco e inicia verifica√ß√£o
            setTimeout(() => {
                verifyAuth();
            }, 1000);
        });

        // onAuthStateChanged como backup
        onAuthStateChanged(auth, (user) => {
            console.log("üîÑ onAuthStateChanged:", user ? "Logado" : "N√£o logado");
            if (user && !userLoaded) {
                console.log("‚úÖ Usu√°rio detectado via onAuthStateChanged:", user.uid);
                cancelRedirect();
                userLoaded = true;
                loadUserProgress(user.uid);
            }
        });

        // Fun√ß√£o para mostrar conte√∫do e esconder loading
        function showContent() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').classList.add('show');
        }

        // Fun√ß√£o para inicializar progresso do usu√°rio
        async function initUserProgress(userId) {
            try {
                console.log("Inicializando progresso para:", userId);
                const response = await fetch('/api/init-progress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });
                const result = await response.json();
                console.log("Inicializa√ß√£o:", result);
                return result.success;
            } catch (error) {
                console.error('Erro ao inicializar progresso:', error);
                return false;
            }
        }

        // Fun√ß√£o para carregar progresso do usu√°rio
        async function loadUserProgress(userId) {
            try {
                console.log("Carregando progresso para:", userId);
                
                // Primeiro inicializa o progresso (se n√£o existir)
                await initUserProgress(userId);
                
                const response = await fetch(`/api/get-progress/${userId}/sequencial`);
                const result = await response.json();
                
                if (result.success) {
                    const { aulas_concluidas, aulas_liberadas, next_lesson } = result;
                    console.log("Progresso carregado:", result);
                    console.log("Aulas conclu√≠das:", aulas_concluidas);
                    console.log("Aulas liberadas:", aulas_liberadas);
                    console.log("Pr√≥xima aula:", next_lesson);
                    
                    updateLessonStates(aulas_concluidas, aulas_liberadas);
                    updateProgressBar(result.progress_percentage, result.total_completed, 10);
                } else {
                    console.error('Erro ao carregar progresso:', result.error);
                    // Se n√£o conseguir carregar, s√≥ a primeira aula fica dispon√≠vel
                    updateLessonStates([], [1]);
                    updateProgressBar(0, 0, 10);
                }
                
                // Mostra o conte√∫do ap√≥s carregar
                showContent();
                
            } catch (error) {
                console.error('Erro ao carregar progresso:', error);
                updateLessonStates([], [1]);
                updateProgressBar(0, 0, 10);
                showContent();
            }
        }

        // Fun√ß√£o para verificar se o usu√°rio est√° realmente logado
        function checkAuthStatus() {
            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    unsubscribe();
                    resolve(user);
                });
            });
        }

        // Fun√ß√£o para atualizar estados visuais das aulas
        function updateLessonStates(aulasConcluidasArray, aulasLiberadas) {
            const aulasCoercluidas = new Set(aulasConcluidasArray || []);
            const aulasLiberadasSet = new Set(aulasLiberadas || [1]); // Primeira aula sempre liberada por padr√£o
            
            console.log("Atualizando estado das aulas:");
            console.log("Conclu√≠das:", aulasConcluidasArray);
            console.log("Liberadas:", aulasLiberadas);
            
            for (let i = 1; i <= 10; i++) {
                const aulaCard = document.getElementById(`aula-${i}`);
                const aulaLink = aulaCard.querySelector('.aula-link');
                const aulaStatus = aulaCard.querySelector('.aula-status');
                
                // Remove todas as classes de estado
                aulaCard.classList.remove('completed', 'available', 'locked');
                
                if (aulasCoercluidas.has(i)) {
                    // Aula conclu√≠da - verde
                    aulaCard.classList.add('completed');
                    aulaStatus.textContent = '‚úÖ Conclu√≠da';
                    aulaLink.style.pointerEvents = 'auto';
                    aulaLink.style.opacity = '1';
                    console.log(`Aula ${i}: Conclu√≠da`);
                } else if (aulasLiberadasSet.has(i)) {
                    // Aula liberada e dispon√≠vel - azul
                    aulaCard.classList.add('available');
                    aulaStatus.textContent = 'üîì Dispon√≠vel';
                    aulaLink.style.pointerEvents = 'auto';
                    aulaLink.style.opacity = '1';
                    console.log(`Aula ${i}: Dispon√≠vel`);
                } else {
                    // Aula bloqueada - cinza
                    aulaCard.classList.add('locked');
                    aulaStatus.textContent = 'üîí Bloqueada';
                    aulaLink.style.pointerEvents = 'none';
                    aulaLink.style.opacity = '0.5';
                    console.log(`Aula ${i}: Bloqueada`);
                }
            }
        }

        // Fun√ß√£o de logout
        window.logout = function() {
            localStorage.clear();
            window.location.href = '/';
        }
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='img/code_logic.ico') }}" alt="CodeLogic">
                <h1>CodeLogic</h1>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/aulas/sequencial" class="nav-link active">Aulas</a>
                <a href="#" onclick="logout()" class="nav-link">Sair</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Loading Screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>Carregando suas aulas...</p>
            </div>
        </div>

        <!-- Content (hidden initially) -->
        <div id="main-content" class="content-wrapper">
            <div class="content-header">
                <h1>üìö Aulas Sequenciais</h1>
                <p class="subtitle">Aprenda programa√ß√£o Python passo a passo</p>
                
                <!-- Bot√£o para pular m√≥dulo -->
                <div class="skip-module-container">
                    <button id="skip-module-btn" class="skip-module-btn" onclick="showSkipModuleModal()">
                        ‚úì J√° tenho esse conhecimento
                    </button>
                </div>
            </div>

        <!-- Aulas Grid -->
        <div class="aulas-grid">
            <div id="aula-1" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/1" class="aula-link">
                    <div class="aula-number">01</div>
                    <div class="aula-info">
                        <h3>Introdu√ß√£o ao Python</h3>
                        <p>Primeiros passos com a linguagem Python</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-2" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/2" class="aula-link">
                    <div class="aula-number">02</div>
                    <div class="aula-info">
                        <h3>Vari√°veis e Tipos</h3>
                        <p>Trabalhando com diferentes tipos de dados</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-3" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/3" class="aula-link">
                    <div class="aula-number">03</div>
                    <div class="aula-info">
                        <h3>Operadores</h3>
                        <p>Opera√ß√µes aritm√©ticas e l√≥gicas</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-4" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/4" class="aula-link">
                    <div class="aula-number">04</div>
                    <div class="aula-info">
                        <h3>Entrada e Sa√≠da</h3>
                        <p>Intera√ß√£o com o usu√°rio</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-5" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/5" class="aula-link">
                    <div class="aula-number">05</div>
                    <div class="aula-info">
                        <h3>Strings</h3>
                        <p>Manipula√ß√£o de texto</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-6" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/6" class="aula-link">
                    <div class="aula-number">06</div>
                    <div class="aula-info">
                        <h3>Matem√°tica</h3>
                        <p>C√°lculos e fun√ß√µes matem√°ticas</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-7" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/7" class="aula-link">
                    <div class="aula-number">07</div>
                    <div class="aula-info">
                        <h3>Formata√ß√£o</h3>
                        <p>Formata√ß√£o de sa√≠das</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-8" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/8" class="aula-link">
                    <div class="aula-number">08</div>
                    <div class="aula-info">
                        <h3>Convers√µes</h3>
                        <p>Convers√£o entre tipos de dados</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-9" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/9" class="aula-link">
                    <div class="aula-number">09</div>
                    <div class="aula-info">
                        <h3>Boas Pr√°ticas</h3>
                        <p>C√≥digo limpo e organizado</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>

            <div id="aula-10" class="aula-card locked">
                <a href="/exercicios/sequencial/aula/10" class="aula-link">
                    <div class="aula-number">10</div>
                    <div class="aula-info">
                        <h3>Projeto Final</h3>
                        <p>Aplicando todos os conceitos</p>
                        <div class="aula-status">üîí Bloqueada</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section">
            <h2>üìä Seu Progresso</h2>
            <div class="progress-info">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill progress-0"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-text">Carregando progresso...</span>
                </div>
            </div>
        </div>
        </div> <!-- Fecha content-wrapper -->
    </main>

    <!-- Modal de confirma√ß√£o para pular m√≥dulo -->
    <div id="skip-module-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Confirmar a√ß√£o</h2>
            </div>
            <div class="modal-body">
                <p>Voc√™ tem certeza que j√° possui conhecimento sobre <strong>Programa√ß√£o Sequencial</strong>?</p>
                <p class="modal-warning">Ao confirmar, todas as aulas deste m√≥dulo ser√£o marcadas como conclu√≠das e o pr√≥ximo m√≥dulo ser√° liberado.</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="hideSkipModuleModal()">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" onclick="skipModule()">Sim, pular m√≥dulo</button>
            </div>
        </div>
    </div>

    <script>
        // Atualiza a barra de progresso quando o progresso √© carregado
        function updateProgressBar(percentage, completed, total) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            // Remove classes antigas
            progressFill.className = 'progress-fill';
            
            // Adiciona nova classe baseada na porcentagem
            if (percentage >= 100) {
                progressFill.classList.add('progress-100');
            } else if (percentage >= 90) {
                progressFill.classList.add('progress-90');
            } else if (percentage >= 80) {
                progressFill.classList.add('progress-80');
            } else if (percentage >= 70) {
                progressFill.classList.add('progress-70');
            } else if (percentage >= 60) {
                progressFill.classList.add('progress-60');
            } else if (percentage >= 50) {
                progressFill.classList.add('progress-50');
            } else if (percentage >= 40) {
                progressFill.classList.add('progress-40');
            } else if (percentage >= 30) {
                progressFill.classList.add('progress-30');
            } else if (percentage >= 20) {
                progressFill.classList.add('progress-20');
            } else if (percentage >= 10) {
                progressFill.classList.add('progress-10');
            } else {
                progressFill.classList.add('progress-0');
            }
            
            progressText.textContent = `${completed}/${total} aulas conclu√≠das (${Math.round(percentage)}%)`;
        }

        // Modifica a fun√ß√£o loadUserProgress para atualizar tamb√©m a barra
        const originalLoadUserProgress = window.loadUserProgress;
        window.loadUserProgress = async function(userId) {
            try {
                const response = await fetch(`/api/get-progress/${userId}/sequencial`);
                const result = await response.json();
                
                if (result.success) {
                    const { aulas_concluidas, aulas_liberadas, next_lesson, progress_percentage, total_completed } = result;
                    updateLessonStates(aulas_concluidas, aulas_liberadas);
                    updateProgressBar(progress_percentage, total_completed, 10);
                } else {
                    console.error('Erro ao carregar progresso:', result.error);
                    updateLessonStates([], [1]);
                    updateProgressBar(0, 0, 10);
                }
                
            } catch (error) {
                console.error('Erro ao carregar progresso:', error);
                updateLessonStates([], [1]);
                updateProgressBar(0, 0, 10);
            }
        }

        // Fun√ß√µes do modal de pular m√≥dulo
        function showSkipModuleModal() {
            const modal = document.getElementById('skip-module-modal');
            modal.style.display = 'flex';
        }

        function hideSkipModuleModal() {
            const modal = document.getElementById('skip-module-modal');
            modal.style.display = 'none';
        }

        // Fun√ß√£o para pular o m√≥dulo
        async function skipModule() {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    alert('Erro: Usu√°rio n√£o identificado');
                    return;
                }

                // Desabilita o bot√£o para evitar m√∫ltiplos cliques
                const confirmBtn = document.querySelector('.modal-btn-confirm');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Processando...';

                const response = await fetch('/api/skip-module', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        module: 'sequencial'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    hideSkipModuleModal();
                    
                    // Mostra mensagem de sucesso
                    alert(`‚úÖ ${result.message}\n\nVoc√™ ser√° redirecionado para o dashboard.`);
                    
                    // Recarrega o progresso
                    await loadUserProgress(userId);
                    
                    // Redireciona para o dashboard ap√≥s 2 segundos
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    alert(`Erro ao pular m√≥dulo: ${result.error}`);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Sim, pular m√≥dulo';
                }

            } catch (error) {
                console.error('Erro ao pular m√≥dulo:', error);
                alert('Erro ao pular m√≥dulo. Tente novamente.');
                const confirmBtn = document.querySelector('.modal-btn-confirm');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Sim, pular m√≥dulo';
            }
        }

        // Fecha o modal ao clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('skip-module-modal');
            if (event.target === modal) {
                hideSkipModuleModal();
            }
        }
    </script>
</body>
</html>