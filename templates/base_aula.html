<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CodeLogic{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='sequencial/base_aula.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/code_logic.ico') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='img/code_logic.ico') }}" alt="CodeLogic">
                <h1>CodeLogic</h1>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="#" class="nav-link" onclick="goToModuleLobby()">Aulas</a>
                <a href="#" class="nav-link" onclick="logout()">Sair</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="lesson-header">
            <h1 class="lesson-title">{% block lesson_title %}{% endblock %}</h1>
            <div class="tab-container">
                <button type="button" class="tab-btn active" data-tab="content" title="Conte√∫do da Aula" aria-label="Aba de Conte√∫do">üìö Conte√∫do</button>
                <button type="button" class="tab-btn" data-tab="exercise" title="Exerc√≠cio Pr√°tico" aria-label="Aba de Exerc√≠cio">üíª Exerc√≠cio</button>
            </div>
        </div>

        <div class="lesson-body">
            <!-- Conte√∫do da aula -->
            <div id="content-tab" class="tab-content active">
                <div class="content-container">
                    {% block lesson_content %}{% endblock %}
                </div>
            </div>

            <!-- Exerc√≠cio -->
            <div id="exercise-tab" class="tab-content">
                <div class="exercise-container">
                    <div class="exercise-description">
                        <h3>üéØ Exerc√≠cio Pr√°tico</h3>
                        {% block exercise_description %}{% endblock %}
                    </div>
                    
                    <div class="code-editor-container">
                        <div class="editor-header">
                            <span>Editor Python</span>
                            <div class="editor-buttons">
                                <button type="button" id="run-code" class="run-btn" title="Executar C√≥digo" aria-label="Executar c√≥digo Python">‚ñ∂Ô∏è Executar</button>
                                <button type="button" id="check-code" class="check-btn" title="Verificar Resposta" aria-label="Verificar resposta do exerc√≠cio">‚úÖ Verificar Resposta</button>
                            </div>
                        </div>
                        <textarea id="code-editor" name="code-editor" placeholder="Digite seu c√≥digo Python aqui..." aria-label="Editor de c√≥digo Python">{% block initial_code %}print("Hello, World!"){% endblock %}</textarea>
                        
                        <div class="output-container">
                            <div class="output-header">Resultado:</div>
                            <div id="output" class="output-content"></div>
                        </div>
                        
                        <!-- Feedback da IA -->
                        <div id="ai-feedback" class="ai-feedback-container">
                            <div class="feedback-header">
                                <span id="feedback-title">üìù Avalia√ß√£o Autom√°tica</span>
                                <span id="feedback-score" class="feedback-score"></span>
                            </div>
                            <div id="feedback-content" class="feedback-content"></div>
                            <div id="feedback-suggestions" class="feedback-suggestions"></div>
                            
                            <!-- Bot√£o Conclu√≠do - aparece apenas quando a resposta est√° correta -->
                            <div id="complete-lesson-container" class="complete-lesson-container">
                                <button type="button" id="complete-lesson-btn" class="complete-btn">
                                    ‚úÖ Marcar Aula como Conclu√≠da
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script>
        // Configura√ß√£o do CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true
        });

        // Altern√¢ncia entre abas
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                
                // Remove active de todas as abas
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Ativa a aba selecionada
                btn.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                
                // Refresh do editor quando mudar para exerc√≠cio
                if (tabName === 'exercise') {
                    setTimeout(() => editor.refresh(), 100);
                }
            });
        });

        // Execu√ß√£o de c√≥digo
        document.getElementById('run-code').addEventListener('click', async () => {
            const code = editor.getValue();
            const output = document.getElementById('output');
            const runBtn = document.getElementById('run-code');
            
            // Feedback visual
            runBtn.textContent = '‚è≥ Executando...';
            runBtn.disabled = true;
            output.innerHTML = '<div class="loading">Executando c√≥digo...</div>';
            
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    output.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Sucesso!</strong>
                            <pre class="output-text">${result.output || 'C√≥digo executado sem sa√≠da.'}</pre>
                        </div>
                    `;
                } else {
                    output.innerHTML = `
                        <div class="error">
                            <strong>‚ùå Erro:</strong>
                            <pre class="error-text">${result.error}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                output.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro de conex√£o:</strong>
                        <pre class="error-text">${error.message}</pre>
                    </div>
                `;
            } finally {
                runBtn.textContent = '‚ñ∂Ô∏è Executar';
                runBtn.disabled = false;
            }
        });

        // Corre√ß√£o autom√°tica
        document.getElementById('check-code').addEventListener('click', async () => {
            const code = editor.getValue();
            const checkBtn = document.getElementById('check-code');
            const feedbackContainer = document.getElementById('ai-feedback');
            
            // Feedback visual
            checkBtn.textContent = 'ü§ñ Verificando...';
            checkBtn.disabled = true;
            
            // Mostra container de feedback
            feedbackContainer.classList.add('show');
            document.getElementById('feedback-content').innerHTML = '<div class="loading">Analisando seu c√≥digo...</div>';
            
            try {
                // Pega a descri√ß√£o do exerc√≠cio do template
                const exerciseDescription = getExerciseDescription();
                const lessonNumber = getLessonNumber();
                
                const response = await fetch('/api/correct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code,
                        exercise_description: exerciseDescription,
                        lesson_number: lessonNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayFeedback(result.correction);
                } else {
                    document.getElementById('feedback-content').innerHTML = `
                        <div class="error">
                            <strong>‚ùå Erro na verifica√ß√£o:</strong>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('feedback-content').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro de conex√£o:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                checkBtn.textContent = '‚úÖ Verificar Resposta';
                checkBtn.disabled = false;
            }
        });

        // Fun√ß√£o para exibir feedback da IA
        function displayFeedback(correction) {
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackScore = document.getElementById('feedback-score');
            const feedbackContent = document.getElementById('feedback-content');
            const feedbackSuggestions = document.getElementById('feedback-suggestions');
            const completeLessonContainer = document.getElementById('complete-lesson-container');
            
            // Atualiza t√≠tulo baseado no resultado
            if (correction.correct === true) {
                feedbackTitle.textContent = 'üéâ Resposta Correta!';
                feedbackTitle.className = 'feedback-title correct';
                // Mostra bot√£o de concluir apenas se a resposta estiver correta
                completeLessonContainer.style.display = 'block';
            } else if (correction.correct === false) {
                feedbackTitle.textContent = 'ü§î Precisa Melhorar';
                feedbackTitle.className = 'feedback-title incorrect';
                completeLessonContainer.style.display = 'none';
            } else {
                feedbackTitle.textContent = 'üìù An√°lise Conclu√≠da';
                feedbackTitle.className = 'feedback-title neutral';
                completeLessonContainer.style.display = 'none';
            }
            
            // Exibe pontua√ß√£o
            feedbackScore.textContent = `${correction.score}/100`;
            feedbackScore.className = `feedback-score ${correction.score >= 70 ? 'good' : correction.score >= 40 ? 'average' : 'poor'}`;
            
            // Exibe feedback principal
            feedbackContent.innerHTML = `
                <div class="feedback-message ${correction.correct ? 'success' : 'warning'}">
                    <p>${correction.feedback}</p>
                </div>
            `;
            
            // Exibe sugest√µes se houver
            if (correction.suggestions && correction.suggestions.length > 0) {
                const suggestionsHtml = correction.suggestions.map(suggestion => 
                    `<li>üí° ${suggestion}</li>`
                ).join('');
                
                feedbackSuggestions.innerHTML = `
                    <div class="suggestions-container">
                        <h4>üí≠ Dicas para Melhorar:</h4>
                        <ul>${suggestionsHtml}</ul>
                    </div>
                `;
            } else {
                feedbackSuggestions.innerHTML = '';
            }
        }

        // Funcionalidade do bot√£o "Marcar como Conclu√≠da"
        document.getElementById('complete-lesson-btn').addEventListener('click', async () => {
            const completeBtn = document.getElementById('complete-lesson-btn');
            const lessonNumber = getLessonNumber();
            
            try {
                completeBtn.textContent = '‚è≥ Salvando...';
                completeBtn.disabled = true;
                
                // Pega o usu√°rio logado do localStorage (mais confi√°vel neste contexto)
                const userId = localStorage.getItem('userId');
                const userName = localStorage.getItem('userName');
                
                if (!userId) {
                    alert('Erro: Usu√°rio n√£o encontrado. Fa√ßa login novamente.');
                    window.location.href = '/';
                    return;
                }
                
                console.log(`üéØ Marcando aula ${lessonNumber} como conclu√≠da para usu√°rio:`, userName);
                
                const response = await fetch('/api/complete-lesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lesson_number: lessonNumber,
                        user_id: userId,
                        module: getModuleName()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    completeBtn.textContent = '‚úÖ Aula Conclu√≠da!';
                    completeBtn.classList.add('completed');
                    
                    console.log('‚úÖ Aula marcada como conclu√≠da:', result);
                    
                    // Mostra mensagem de sucesso
                    showSuccessMessage(`Parab√©ns! Aula ${lessonNumber} conclu√≠da. Progresso: ${result.total_completed}/10 aulas.`);
                    
                    // Redireciona de volta para o lobby do m√≥dulo ap√≥s alguns segundos
                    setTimeout(() => {
                        const moduleName = getModuleName();
                        console.log(`Redirecionando para o lobby do m√≥dulo: ${moduleName}`);
                        window.location.href = `/aulas/${moduleName}`;
                    }, 2000);
                    
                } else {
                    console.error('‚ùå Erro do servidor:', result.error);
                    completeBtn.textContent = '‚ùå Erro ao salvar';
                    alert(`Erro ao salvar progresso: ${result.error}`);
                    setTimeout(() => {
                        completeBtn.textContent = '‚úÖ Marcar como Conclu√≠da';
                        completeBtn.disabled = false;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar aula como conclu√≠da:', error);
                completeBtn.textContent = '‚ùå Erro de conex√£o';
                alert(`Erro de conex√£o: ${error.message}`);
                setTimeout(() => {
                    completeBtn.textContent = '‚úÖ Marcar como Conclu√≠da';
                    completeBtn.disabled = false;
                }, 2000);
            }
        });

        // Fun√ß√£o para mostrar mensagem de sucesso
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-notification';
            successDiv.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">üéâ</span>
                    <span class="success-text">${message}</span>
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            // Remove a mensagem ap√≥s 5 segundos
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Fun√ß√£o para obter descri√ß√£o do exerc√≠cio (implementada em cada aula)
        function getExerciseDescription() {
            // Esta fun√ß√£o ser√° sobrescrita em cada template de aula espec√≠fica
            return document.querySelector('.exercise-description')?.textContent || 'Exerc√≠cio de programa√ß√£o Python';
        }

        // Fun√ß√£o para obter n√∫mero da aula
        function getLessonNumber() {
            // Extrai o n√∫mero da aula da URL ou do contexto
            const pathname = window.location.pathname;
            const match = pathname.match(/(\d+)/);
            return match ? parseInt(match[1]) : 1;
        }

        // Fun√ß√£o para obter m√≥dulo da aula
        function getModuleName() {
            const pathname = window.location.pathname;
            if (pathname.includes('sequencial')) return 'sequencial';
            if (pathname.includes('comparativa')) return 'comparativa';
            if (pathname.includes('repetitiva')) return 'repetitiva';
            if (pathname.includes('vetores')) return 'vetores';
            if (pathname.includes('matrizes')) return 'matrizes';
            return 'sequencial'; // default
        }

        // Fun√ß√£o de logout
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // Fun√ß√£o para ir ao lobby do m√≥dulo atual
        function goToModuleLobby() {
            const moduleName = getModuleName();
            console.log(`Navegando para o lobby do m√≥dulo: ${moduleName}`);
            window.location.href = `/aulas/${moduleName}`;
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>