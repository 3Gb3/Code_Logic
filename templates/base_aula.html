<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CodeLogic{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='sequencial/base_aula.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/code_logic.ico') }}">
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <style>
        .output-container {
            background: #111B2C;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(102, 126, 234, 0.3);
            font-family: 'Courier New', monospace;
            color: #ECEFF1;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(17, 27, 44, 0.95);
            border-radius: 6px 6px 0 0;
            margin: -15px -15px 10px -15px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .output-title {
            color: #ECEFF1;
            font-size: 14px;
            font-weight: 500;
        }
        
        .input-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .input-modal.show {
            display: flex;
        }
        
        .input-modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
        }
        
        .input-modal-title {
            color: #00DC6E;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .input-list {
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            color: #ECEFF1;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            background: #111B2C;
            color: #ECEFF1;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #00DC6E;
        }
        
        .input-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .input-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        
        .input-modal-btn.submit {
            background: #00DC6E;
            color: #111B2C;
        }
        
        .input-modal-btn.cancel {
            background: #dc2626;
            color: white;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Floating animated orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    
    <header class="header">
        <div class="nav-container">
            <a href="/dashboard" class="logo" style="text-decoration: none; color: inherit;">
                <img src="{{ url_for('static', filename='img/code_logic.ico') }}" alt="CodeLogic">
                <h1>CodeLogic</h1>
            </a>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="#" class="nav-link" onclick="goToModuleLobby()">Aulas</a>
                <a href="#" class="nav-link" onclick="logout()">Sair</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="lesson-header">
            <h1 class="lesson-title">{% block lesson_title %}{% endblock %}</h1>
            <div class="tab-container">
                <button type="button" class="tab-btn active" data-tab="content" title="Conte√∫do da Aula" aria-label="Aba de Conte√∫do">üìö Conte√∫do</button>
                <button type="button" class="tab-btn" data-tab="exercise" title="Exerc√≠cio Pr√°tico" aria-label="Aba de Exerc√≠cio">üíª Exerc√≠cio</button>
            </div>
        </div>

        <div class="lesson-body">
            <!-- Conte√∫do da aula -->
            <div id="content-tab" class="tab-content active">
                <div class="content-container">
                    {% block lesson_content %}{% endblock %}
                </div>
            </div>

            <!-- Exerc√≠cio -->
            <div id="exercise-tab" class="tab-content">
                <div class="exercise-container">
                    <div class="exercise-description">
                        <h3>üéØ Exerc√≠cio Pr√°tico</h3>
                        {% block exercise_description %}{% endblock %}
                    </div>
                    
                    <div class="code-editor-container">
                        <div class="editor-header">
                            <span>Editor Python</span>
                            <div class="editor-buttons">
                                <button type="button" id="run-code" class="run-btn" title="Executar C√≥digo" aria-label="Executar c√≥digo Python">‚ñ∂Ô∏è Executar</button>
                                <button type="button" id="clear-output" class="run-btn" title="Limpar Sa√≠da" aria-label="Limpar sa√≠da" style="background: #555;">üóëÔ∏è Limpar</button>
                                <button type="button" id="check-code" class="check-btn" title="Verificar Resposta" aria-label="Verificar resposta do exerc√≠cio">‚úÖ Verificar</button>
                            </div>
                        </div>
                        <textarea id="code-editor" name="code-editor" placeholder="Digite seu c√≥digo Python aqui..." aria-label="Editor de c√≥digo Python">{% block initial_code %}print("Hello, World!"){% endblock %}</textarea>
                        
                        <!-- √Årea de Sa√≠da -->
                        <div class="output-container">
                            <div class="output-header">
                                <span class="output-title">üìü Sa√≠da do Programa</span>
                            </div>
                            <div id="output-content">Clique em "‚ñ∂Ô∏è Executar" para ver a sa√≠da do seu c√≥digo...</div>
                        </div>
                        
                        <!-- Modal de Input -->
                        <div id="input-modal" class="input-modal">
                            <div class="input-modal-content">
                                <h3 class="input-modal-title">üìù Valores de Entrada</h3>
                                <p style="color: #94a3b8; margin-bottom: 20px; font-size: 14px;">
                                    Seu c√≥digo precisa de valores de entrada. Digite os valores abaixo:
                                </p>
                                <div id="input-list" class="input-list"></div>
                                <div class="input-modal-buttons">
                                    <button class="input-modal-btn cancel" onclick="closeInputModal()">Cancelar</button>
                                    <button class="input-modal-btn submit" onclick="submitInputs()">Executar</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Feedback da IA -->
                        <div id="ai-feedback" class="ai-feedback-container">
                            <div class="feedback-header">
                                <span id="feedback-title">üìù Avalia√ß√£o Autom√°tica</span>
                                <span id="feedback-score" class="feedback-score"></span>
                            </div>
                            <div id="feedback-content" class="feedback-content"></div>
                            <div id="feedback-suggestions" class="feedback-suggestions"></div>
                            
                            <!-- Bot√£o Conclu√≠do -->
                            <div id="complete-lesson-container" class="complete-lesson-container">
                                <button type="button" id="complete-lesson-btn" class="complete-btn">
                                    ‚úÖ Marcar Aula como Conclu√≠da
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    
    <script>
        // ============================================
        // Inicializa√ß√£o do CodeMirror
        // ============================================
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true
        });

        // ============================================
        // Executar c√≥digo
        // ============================================
        document.getElementById('run-code').addEventListener('click', async () => {
            const code = editor.getValue();
            const outputDiv = document.getElementById('output-content');
            const runBtn = document.getElementById('run-code');
            
            if (!code.trim()) {
                outputDiv.textContent = '‚ö†Ô∏è C√≥digo vazio';
                return;
            }
            
            runBtn.textContent = '‚è≥ Executando...';
            runBtn.disabled = true;
            outputDiv.textContent = '‚è≥ Executando c√≥digo...';
            
            try {
                // Primeiro tenta executar sem inputs
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, inputs: null })
                });
                
                const result = await response.json();
                
                // Se precisa de inputs, abre modal
                if (result.input_needed) {
                    openInputModal(result.input_count, code);
                    runBtn.textContent = '‚ñ∂Ô∏è Executar';
                    runBtn.disabled = false;
                    outputDiv.textContent = 'Aguardando valores de entrada...';
                } else {
                    displayOutput(result);
                    runBtn.textContent = '‚ñ∂Ô∏è Executar';
                    runBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('Erro:', error);
                outputDiv.textContent = `‚ùå Erro de conex√£o: ${error.message}`;
                runBtn.textContent = '‚ñ∂Ô∏è Executar';
                runBtn.disabled = false;
            }
        });
        
        // ============================================
        // Modal de Input
        // ============================================
        function openInputModal(count, code) {
            const modal = document.getElementById('input-modal');
            const inputList = document.getElementById('input-list');
            
            // Limpa lista anterior
            inputList.innerHTML = '';
            
            // Cria campos de input
            for (let i = 1; i <= count; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                inputGroup.innerHTML = `
                    <label for="input-${i}">Valor ${i}:</label>
                    <input type="text" id="input-${i}" placeholder="Digite o valor ${i}">
                `;
                inputList.appendChild(inputGroup);
            }
            
            // Armazena o c√≥digo para executar depois
            modal.dataset.code = code;
            modal.dataset.count = count;
            
            modal.classList.add('show');
            
            // Foca no primeiro input
            setTimeout(() => {
                document.getElementById('input-1')?.focus();
            }, 100);
        }
        
        function closeInputModal() {
            const modal = document.getElementById('input-modal');
            modal.classList.remove('show');
        }
        
        async function submitInputs() {
            const modal = document.getElementById('input-modal');
            const code = modal.dataset.code;
            const count = parseInt(modal.dataset.count);
            const outputDiv = document.getElementById('output-content');
            const runBtn = document.getElementById('run-code');
            
            // Coleta inputs
            const inputs = [];
            for (let i = 1; i <= count; i++) {
                const input = document.getElementById(`input-${i}`).value;
                if (input === '') {
                    alert(`Por favor, preencha o Valor ${i}`);
                    return;
                }
                inputs.push(input);
            }
            
            closeInputModal();
            
            runBtn.textContent = '‚è≥ Executando...';
            runBtn.disabled = true;
            outputDiv.textContent = '‚è≥ Executando c√≥digo com valores fornecidos...';
            
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, inputs: inputs })
                });
                
                const result = await response.json();
                displayOutput(result);
                
            } catch (error) {
                console.error('Erro:', error);
                outputDiv.textContent = `‚ùå Erro de conex√£o: ${error.message}`;
            } finally {
                runBtn.textContent = '‚ñ∂Ô∏è Executar';
                runBtn.disabled = false;
            }
        }
        
        // ============================================
        // Exibir sa√≠da
        // ============================================
        function displayOutput(result) {
            const outputDiv = document.getElementById('output-content');
            
            if (result.success) {
                let output = result.output || '(sem sa√≠da)';
                if (result.error) {
                    output += '\n\n‚ö†Ô∏è Avisos:\n' + result.error;
                }
                outputDiv.textContent = output;
            } else {
                outputDiv.textContent = `‚ùå Erro:\n${result.error}`;
            }
        }
        
        // ============================================
        // Limpar sa√≠da
        // ============================================
        document.getElementById('clear-output').addEventListener('click', () => {
            document.getElementById('output-content').textContent = 'Sa√≠da limpa. Clique em "‚ñ∂Ô∏è Executar" para executar seu c√≥digo.';
        });
        
        // ============================================
        // Altern√¢ncia entre abas
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                
                if (tabName === 'exercise') {
                    setTimeout(() => {
                        editor.refresh();
                    }, 100);
                }
            });
        });
        
        // ============================================
        // Corre√ß√£o autom√°tica com IA
        // ============================================
        document.getElementById('check-code').addEventListener('click', async () => {
            const code = editor.getValue();
            const checkBtn = document.getElementById('check-code');
            const feedbackContainer = document.getElementById('ai-feedback');
            
            checkBtn.textContent = 'ü§ñ Verificando...';
            checkBtn.disabled = true;
            
            feedbackContainer.classList.add('show');
            document.getElementById('feedback-content').innerHTML = '<div class="loading">Analisando seu c√≥digo...</div>';
            
            try {
                const exerciseDescription = getExerciseDescription();
                const lessonNumber = getLessonNumber();
                
                const response = await fetch('/api/correct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code: code,
                        exercise_description: exerciseDescription,
                        lesson_number: lessonNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayFeedback(result.correction);
                } else {
                    const errorMsg = result.error || result.details || 'Erro desconhecido';
                    document.getElementById('feedback-content').innerHTML = `
                        <div class="error">
                            <strong>‚ùå Erro na verifica√ß√£o:</strong>
                            <p>${errorMsg}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao verificar c√≥digo:', error);
                document.getElementById('feedback-content').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro de conex√£o:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                checkBtn.textContent = '‚úÖ Verificar';
                checkBtn.disabled = false;
            }
        });

        // ============================================
        // Exibir feedback da IA
        // ============================================
        function displayFeedback(correction) {
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackScore = document.getElementById('feedback-score');
            const feedbackContent = document.getElementById('feedback-content');
            const feedbackSuggestions = document.getElementById('feedback-suggestions');
            const completeLessonContainer = document.getElementById('complete-lesson-container');
            
            if (correction.correct === true) {
                feedbackTitle.textContent = 'üéâ Resposta Correta!';
                completeLessonContainer.style.display = 'block';
            } else if (correction.correct === false) {
                feedbackTitle.textContent = 'ü§î Precisa Melhorar';
                completeLessonContainer.style.display = 'none';
            } else {
                feedbackTitle.textContent = 'üìù An√°lise Conclu√≠da';
                completeLessonContainer.style.display = 'none';
            }
            
            // Classe do score baseada na pontua√ß√£o
            feedbackScore.textContent = `${correction.score}/100`;
            feedbackScore.className = 'feedback-score';
            if (correction.score >= 90) {
                feedbackScore.classList.add('perfect');
            } else if (correction.score >= 70) {
                feedbackScore.classList.add('good');
            } else {
                feedbackScore.classList.add('needs-improvement');
            }
            
            // Feedback com estilo apropriado
            const messageClass = correction.correct ? 'success-message' : 
                                correction.score >= 70 ? 'info-message' : 'warning-message';
            
            feedbackContent.innerHTML = `
                <div class="${messageClass}">
                    <p>${correction.feedback}</p>
                </div>
            `;
            
            if (correction.suggestions && correction.suggestions.length > 0) {
                const suggestionsHtml = correction.suggestions.map(suggestion => 
                    `<li>${suggestion}</li>`
                ).join('');
                
                feedbackSuggestions.innerHTML = `
                    <h4>üí° Sugest√µes de Melhoria</h4>
                    <ul>${suggestionsHtml}</ul>
                `;
                feedbackSuggestions.style.display = 'block';
            } else {
                feedbackSuggestions.style.display = 'none';
            }
        }

        // ============================================
        // Marcar aula como conclu√≠da
        // ============================================
        document.getElementById('complete-lesson-btn').addEventListener('click', async () => {
            const completeBtn = document.getElementById('complete-lesson-btn');
            const lessonNumber = getLessonNumber();
            
            try {
                completeBtn.textContent = '‚è≥ Salvando...';
                completeBtn.disabled = true;
                
                const userId = localStorage.getItem('userId');
                
                if (!userId) {
                    alert('Erro: Usu√°rio n√£o encontrado. Fa√ßa login novamente.');
                    window.location.href = '/';
                    return;
                }
                
                const response = await fetch('/api/complete-lesson', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lesson_number: lessonNumber,
                        user_id: userId,
                        module: getModuleName()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    completeBtn.textContent = '‚úÖ Aula Conclu√≠da!';
                    completeBtn.classList.add('completed');
                    
                    showSuccessMessage(`Parab√©ns! Aula ${lessonNumber} conclu√≠da. Progresso: ${result.total_completed}/10 aulas.`);
                    
                    setTimeout(() => {
                        const moduleName = getModuleName();
                        window.location.href = `/aulas/${moduleName}`;
                    }, 2000);
                    
                } else {
                    completeBtn.textContent = '‚ùå Erro ao salvar';
                    alert(`Erro ao salvar progresso: ${result.error}`);
                    setTimeout(() => {
                        completeBtn.textContent = '‚úÖ Marcar como Conclu√≠da';
                        completeBtn.disabled = false;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar aula como conclu√≠da:', error);
                completeBtn.textContent = '‚ùå Erro de conex√£o';
                alert(`Erro de conex√£o: ${error.message}`);
                setTimeout(() => {
                    completeBtn.textContent = '‚úÖ Marcar como Conclu√≠da';
                    completeBtn.disabled = false;
                }, 2000);
            }
        });

        // ============================================
        // Mostrar mensagem de sucesso
        // ============================================
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-notification';
            successDiv.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">üéâ</span>
                    <span class="success-text">${message}</span>
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }
        
        // ============================================
        // Fun√ß√µes auxiliares
        // ============================================
        
        function getExerciseDescription() {
            const descriptionElement = document.querySelector('.exercise-description');
            if (!descriptionElement) {
                return 'Exerc√≠cio de programa√ß√£o Python';
            }
            
            // Captura TODO o HTML interno, incluindo formata√ß√£o e exemplos
            const fullHTML = descriptionElement.innerHTML;
            
            // Remove tags HTML mas preserva a estrutura e exemplos
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHTML;
            
            // Extrai o texto preservando quebras de linha e estrutura
            let description = '';
            
            // Processa cada elemento filho
            tempDiv.querySelectorAll('*').forEach(element => {
                const tagName = element.tagName.toLowerCase();
                
                // Adiciona quebras de linha apropriadas
                if (['h3', 'h4', 'p', 'li', 'div'].includes(tagName)) {
                    description += '\n';
                }
                
                // Captura c√≥digo/exemplos especialmente
                if (tagName === 'code' || tagName === 'pre') {
                    description += '\n```\n' + element.textContent.trim() + '\n```\n';
                } else if (element.textContent.trim()) {
                    description += element.textContent.trim() + ' ';
                }
            });
            
            // Se n√£o conseguiu processar, usa textContent direto
            if (!description.trim()) {
                description = descriptionElement.textContent;
            }
            
            return description.trim() || 'Exerc√≠cio de programa√ß√£o Python';
        }
        
        function getLessonNumber() {
            const pathname = window.location.pathname;
            const match = pathname.match(/(\d+)/);
            return match ? parseInt(match[1]) : 1;
        }
        
        function getModuleName() {
            const pathname = window.location.pathname;
            if (pathname.includes('sequencial')) return 'sequencial';
            if (pathname.includes('comparativa')) return 'comparativa';
            if (pathname.includes('repetitiva')) return 'repetitiva';
            if (pathname.includes('vetores')) return 'vetores';
            if (pathname.includes('matrizes')) return 'matrizes';
            return 'sequencial';
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        function goToModuleLobby() {
            const moduleName = getModuleName();
            window.location.href = `/aulas/${moduleName}`;
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
