<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CodeLogic{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='sequencial/base_aula.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/code_logic.ico') }}">
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Xterm.js para terminal interativo -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    
    <style>
        /* Estilos para o terminal interativo */
        .terminal-container {
            background: #111B2C;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            min-height: 400px;
            max-height: 600px;
            overflow: hidden;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(17, 27, 44, 0.95);
            border-radius: 6px 6px 0 0;
            margin: -10px -10px 10px -10px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .terminal-title {
            color: #ECEFF1;
            font-size: 14px;
            font-weight: 500;
        }
        
        .terminal-controls {
            display: flex;
            gap: 8px;
        }
        
        .terminal-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        
        .terminal-control-btn.close { background: #ff5f56; }
        .terminal-control-btn.minimize { background: #ffbd2e; }
        .terminal-control-btn.maximize { background: #27c93f; }
        
        #terminal {
            height: 500px;
            padding: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.idle { background: #888; animation: none; }
        .status-indicator.running { background: #00DC6E; }
        .status-indicator.waiting { background: #ffbd2e; }
        .status-indicator.error { background: #f92672; animation: none; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='img/code_logic.ico') }}" alt="CodeLogic">
                <h1>CodeLogic</h1>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="#" class="nav-link" onclick="goToModuleLobby()">Aulas</a>
                <a href="#" class="nav-link" onclick="logout()">Sair</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="lesson-header">
            <h1 class="lesson-title">{% block lesson_title %}{% endblock %}</h1>
            <div class="tab-container">
                <button type="button" class="tab-btn active" data-tab="content" title="Conte√∫do da Aula" aria-label="Aba de Conte√∫do">üìö Conte√∫do</button>
                <button type="button" class="tab-btn" data-tab="exercise" title="Exerc√≠cio Pr√°tico" aria-label="Aba de Exerc√≠cio">üíª Exerc√≠cio</button>
            </div>
        </div>

        <div class="lesson-body">
            <!-- Conte√∫do da aula -->
            <div id="content-tab" class="tab-content active">
                <div class="content-container">
                    {% block lesson_content %}{% endblock %}
                </div>
            </div>

            <!-- Exerc√≠cio com Terminal Interativo -->
            <div id="exercise-tab" class="tab-content">
                <div class="exercise-container">
                    <div class="exercise-description">
                        <h3>üéØ Exerc√≠cio Pr√°tico</h3>
                        {% block exercise_description %}{% endblock %}
                    </div>
                    
                    <div class="code-editor-container">
                        <div class="editor-header">
                            <span>Editor Python</span>
                            <div class="editor-buttons">
                                <button type="button" id="run-code" class="run-btn" title="Executar C√≥digo" aria-label="Executar c√≥digo Python">‚ñ∂Ô∏è Executar</button>
                                <button type="button" id="stop-code" class="run-btn" title="Parar Execu√ß√£o" aria-label="Parar execu√ß√£o" style="background: #dc2626; display: none;">‚èπÔ∏è Parar</button>
                                <button type="button" id="clear-terminal" class="run-btn" title="Limpar Terminal" aria-label="Limpar terminal" style="background: #555;">üóëÔ∏è Limpar</button>
                                <button type="button" id="check-code" class="check-btn" title="Verificar Resposta" aria-label="Verificar resposta do exerc√≠cio">‚úÖ Verificar</button>
                            </div>
                        </div>
                        <textarea id="code-editor" name="code-editor" placeholder="Digite seu c√≥digo Python aqui..." aria-label="Editor de c√≥digo Python">{% block initial_code %}print("Hello, World!"){% endblock %}</textarea>
                        
                        <!-- Terminal Interativo -->
                        <div class="terminal-container">
                            <div class="terminal-header">
                                <span class="terminal-title">
                                    <span id="status-indicator" class="status-indicator idle"></span>
                                    <span id="terminal-status">Terminal Interativo Python</span>
                                </span>
                                <div class="terminal-controls">
                                    <button class="terminal-control-btn close" title="Fechar" disabled></button>
                                    <button class="terminal-control-btn minimize" title="Minimizar" disabled></button>
                                    <button class="terminal-control-btn maximize" title="Maximizar" disabled></button>
                                </div>
                            </div>
                            <div id="terminal"></div>
                        </div>
                        
                        <!-- Feedback da IA -->
                        <div id="ai-feedback" class="ai-feedback-container">
                            <div class="feedback-header">
                                <span id="feedback-title">üìù Avalia√ß√£o Autom√°tica</span>
                                <span id="feedback-score" class="feedback-score"></span>
                            </div>
                            <div id="feedback-content" class="feedback-content"></div>
                            <div id="feedback-suggestions" class="feedback-suggestions"></div>
                            
                            <!-- Bot√£o Conclu√≠do -->
                            <div id="complete-lesson-container" class="complete-lesson-container">
                                <button type="button" id="complete-lesson-btn" class="complete-btn">
                                    ‚úÖ Marcar Aula como Conclu√≠da
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    
    <script>
        // ============================================
        // Inicializa√ß√£o do CodeMirror
        // ============================================
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true
        });

        // ============================================
        // Inicializa√ß√£o do Terminal (xterm.js)
        // ============================================
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 15,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            theme: {
                background: '#111B2C',
                foreground: '#ECEFF1',
                cursor: '#00DC6E',
                cursorAccent: '#111B2C',
                selection: 'rgba(102, 126, 234, 0.4)',
                black: '#1E2A3A',
                red: '#f92672',
                green: '#00DC6E',
                yellow: '#FFD700',
                blue: '#667eea',
                magenta: '#ae81ff',
                cyan: '#00DC6E',
                white: '#ECEFF1',
                brightBlack: '#555',
                brightRed: '#ff6b9d',
                brightGreen: '#4ade80',
                brightYellow: '#fbbf24',
                brightBlue: '#818cf8',
                brightMagenta: '#c4b5fd',
                brightCyan: '#4ade80',
                brightWhite: '#ffffff'
            }
        });
        
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();
        
        term.writeln('\x1b[1;32müêç Terminal Python Interativo\x1b[0m');
        term.writeln('\x1b[90mClique em "\x1b[32m‚ñ∂Ô∏è Executar\x1b[90m" para rodar seu c√≥digo.\x1b[0m\n');
        
        // Buffer para input do usu√°rio
        let inputBuffer = '';
        let isWaitingForInput = false;
        let executionTimeout = null;  // Timeout de seguran√ßa
        let isExecuting = false;  // Flag para evitar m√∫ltiplas execu√ß√µes
        
        // Fun√ß√£o de debug
        function debugLog(msg, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            if (data) {
                console.log(`[${timestamp}] ${msg}`, data);
            } else {
                console.log(`[${timestamp}] ${msg}`);
            }
        }
        
        // ============================================
        // WebSocket para comunica√ß√£o em tempo real
        // ============================================
        const socket = io();
        
        socket.on('connect', () => {
            debugLog('‚úÖ Conectado ao servidor WebSocket:', socket.id);
            socket.emit('join_session', { session_id: socket.id });
            updateStatus('idle', 'Pronto');
        });
        
        socket.on('disconnect', () => {
            debugLog('‚ö†Ô∏è Desconectado do servidor WebSocket');
            updateStatus('error', 'Desconectado');
        });
        
        socket.on('output', (data) => {
            debugLog('[OUTPUT] Dados recebidos:', data.data.substring(0, 50));
            term.write(data.data);
        });
        
        socket.on('request_input', (data) => {
            debugLog('[INPUT] Request recebido:', data.prompt);
            term.write(data.prompt);
            isWaitingForInput = true;
            updateStatus('waiting', 'Aguardando entrada...');
        });
        
        socket.on('execution_started', () => {
            debugLog('[EXEC] Execu√ß√£o INICIADA pelo servidor');
            isExecuting = true;
            updateStatus('running', 'Executando...');
        });
        
        socket.on('execution_complete', (data) => {
            debugLog('[EXEC] Execu√ß√£o COMPLETA:', data);
            
            isExecuting = false;
            
            // Limpa o timeout de seguran√ßa
            if (executionTimeout) {
                clearTimeout(executionTimeout);
                executionTimeout = null;
            }
            
            // SEMPRE reseta o estado dos bot√µes
            isWaitingForInput = false;
            inputBuffer = '';
            
            if (data.success) {
                term.write('\n\r‚úÖ Execu√ß√£o conclu√≠da.\n\r');
            } else if (data.error) {
                term.write(`\n\r‚ùå Erro: ${data.error}\n\r`);
            }
            
            // For√ßa volta ao estado idle
            updateStatus('idle', 'Pronto');
        });
        
        socket.on('error', (data) => {
            debugLog('[ERROR] Erro recebido:', data);
            term.write(`\n\r‚ùå ${data.message}\n\r`);
            updateStatus('error', 'Erro');
        });
        
        socket.on('reset_complete', (data) => {
            debugLog('[RESET] Reset completo confirmado pelo servidor');
        });
        
        // ============================================
        // Handle terminal input
        // ============================================
        term.onData((data) => {
            if (!isWaitingForInput) return;
            
            const code = data.charCodeAt(0);
            
            // Enter key
            if (code === 13) {
                term.write('\r\n');
                socket.emit('provide_input', { input: inputBuffer });
                inputBuffer = '';
                isWaitingForInput = false;
                return;
            }
            
            // Backspace
            if (code === 127 || code === 8) {
                if (inputBuffer.length > 0) {
                    inputBuffer = inputBuffer.slice(0, -1);
                    term.write('\b \b');
                }
                return;
            }
            
            // Control characters
            if (code < 32) return;
            
            inputBuffer += data;
            term.write(data);
        });
        
        // ============================================
        // Atualizar status
        // ============================================
        function updateStatus(state, message) {
            debugLog(`üìä updateStatus: ${state} - ${message}`);
            
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('terminal-status');
            const runBtn = document.getElementById('run-code');
            const stopBtn = document.getElementById('stop-code');
            
            if (!runBtn || !stopBtn) {
                console.error('‚ùå Bot√µes n√£o encontrados!');
                return;
            }
            
            indicator.className = `status-indicator ${state}`;
            statusText.textContent = message;
            
            // Mostra/oculta bot√µes baseado no estado
            if (state === 'running' || state === 'waiting') {
                debugLog('  ‚Üí Escondendo Executar, mostrando Parar');
                runBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                debugLog('  ‚Üí Mostrando Executar, escondendo Parar');
                runBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                runBtn.disabled = false;
                runBtn.textContent = '‚ñ∂Ô∏è Executar';
            }
        }
        
        // ============================================
        // Executar c√≥digo
        // ============================================
        document.getElementById('run-code').addEventListener('click', () => {
            debugLog('üñ±Ô∏è Bot√£o EXECUTAR clicado');
            
            // Previne m√∫ltiplos cliques enquanto est√° executando
            if (isExecuting) {
                debugLog('‚ö†Ô∏è  J√° est√° executando, ignorando clique');
                term.write('\r\n\x1b[33m‚ö†Ô∏è  Aguarde a execu√ß√£o atual terminar ou clique em Parar\x1b[0m\r\n');
                return;
            }
            
            const code = editor.getValue();
            
            if (!code.trim()) {
                term.write('‚ö†Ô∏è  C√≥digo vazio\n\r');
                return;
            }
            
            // Limpa timeout anterior se existir
            if (executionTimeout) {
                clearTimeout(executionTimeout);
            }
            
            // Marca como executando
            isExecuting = true;
            
            // Muda para estado "executando" IMEDIATAMENTE
            debugLog('üîÑ Mudando estado para RUNNING');
            updateStatus('running', 'Executando...');
            
            term.write('\n\r' + '='.repeat(50) + '\n\r');
            
            debugLog('üì§ Enviando c√≥digo para servidor', code.substring(0, 50) + '...');
            socket.emit('execute_code', { code: code });
            
            // Timeout de seguran√ßa: 5 minutos m√°ximo
            executionTimeout = setTimeout(() => {
                debugLog('[TIMEOUT] Execu√ß√£o demorou mais de 5 minutos');
                isExecuting = false;
                updateStatus('idle', 'Pronto');
                term.write('\r\n\x1b[33m‚ö†Ô∏è  Timeout: execu√ß√£o muito longa\x1b[0m\r\n');
            }, 300000);
        });
        
        // ============================================
        // Parar execu√ß√£o
        // ============================================
        document.getElementById('stop-code').addEventListener('click', () => {
            debugLog('üõë Bot√£o PARAR clicado');
            
            // Limpa o timeout de seguran√ßa
            if (executionTimeout) {
                clearTimeout(executionTimeout);
                executionTimeout = null;
            }
            
            isExecuting = false;
            
            term.write('\r\n\x1b[33m‚ö†Ô∏è  Parando execu√ß√£o...\x1b[0m\r\n');
            socket.emit('stop_execution');
            updateStatus('idle', 'Pronto');
        });
        
        // ============================================
        // Limpar terminal
        // ============================================
        document.getElementById('clear-terminal').addEventListener('click', () => {
            debugLog('üóëÔ∏è Bot√£o LIMPAR clicado - Reset completo do sistema');
            
            // 1. Para qualquer execu√ß√£o em andamento
            if (isExecuting || isWaitingForInput) {
                socket.emit('stop_execution');
            }
            
            // 2. Envia comando de reset para o servidor
            socket.emit('reset_session');
            
            // 3. Limpa todos os timeouts
            if (executionTimeout) {
                clearTimeout(executionTimeout);
                executionTimeout = null;
            }
            
            // 4. Reseta todos os estados
            isExecuting = false;
            isWaitingForInput = false;
            inputBuffer = '';
            
            // 5. Limpa o terminal
            term.clear();
            term.writeln('\x1b[1;32müêç Terminal Python Interativo\x1b[0m');
            term.writeln('\x1b[90mClique em "\x1b[32m‚ñ∂Ô∏è Executar\x1b[90m" para rodar seu c√≥digo.\x1b[0m\n');
            
            // 6. Reseta o status
            updateStatus('idle', 'Pronto');
            
            debugLog('‚úÖ Reset completo realizado');
        });
        
        // ============================================
        // Altern√¢ncia entre abas
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                
                if (tabName === 'exercise') {
                    setTimeout(() => {
                        editor.refresh();
                        fitAddon.fit();
                    }, 100);
                }
            });
        });
        
        // ============================================
        // Resize terminal on window resize
        // ============================================
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });
        
        // ============================================
        // Corre√ß√£o autom√°tica com IA
        // ============================================
        document.getElementById('check-code').addEventListener('click', async () => {
            const code = editor.getValue();
            const checkBtn = document.getElementById('check-code');
            const feedbackContainer = document.getElementById('ai-feedback');
            
            checkBtn.textContent = 'ü§ñ Verificando...';
            checkBtn.disabled = true;
            
            feedbackContainer.classList.add('show');
            document.getElementById('feedback-content').innerHTML = '<div class="loading">Analisando seu c√≥digo...</div>';
            
            try {
                const exerciseDescription = getExerciseDescription();
                const lessonNumber = getLessonNumber();
                
                const response = await fetch('/api/correct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code,
                        exercise_description: exerciseDescription,
                        lesson_number: lessonNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayFeedback(result.correction);
                } else {
                    const errorMsg = result.error || result.details || 'Erro desconhecido';
                    document.getElementById('feedback-content').innerHTML = `
                        <div class="error">
                            <strong>‚ùå Erro na verifica√ß√£o:</strong>
                            <p>${errorMsg}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao verificar c√≥digo:', error);
                document.getElementById('feedback-content').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro de conex√£o:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                checkBtn.textContent = '‚úÖ Verificar';
                checkBtn.disabled = false;
            }
        });

        // ============================================
        // Exibir feedback da IA
        // ============================================
        function displayFeedback(correction) {
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackScore = document.getElementById('feedback-score');
            const feedbackContent = document.getElementById('feedback-content');
            const feedbackSuggestions = document.getElementById('feedback-suggestions');
            const completeLessonContainer = document.getElementById('complete-lesson-container');
            
            if (correction.correct === true) {
                feedbackTitle.textContent = 'üéâ Resposta Correta!';
                feedbackTitle.className = 'feedback-title correct';
                completeLessonContainer.style.display = 'block';
            } else if (correction.correct === false) {
                feedbackTitle.textContent = 'ü§î Precisa Melhorar';
                feedbackTitle.className = 'feedback-title incorrect';
                completeLessonContainer.style.display = 'none';
            } else {
                feedbackTitle.textContent = 'üìù An√°lise Conclu√≠da';
                feedbackTitle.className = 'feedback-title neutral';
                completeLessonContainer.style.display = 'none';
            }
            
            feedbackScore.textContent = `${correction.score}/100`;
            feedbackScore.className = `feedback-score ${correction.score >= 70 ? 'good' : correction.score >= 40 ? 'average' : 'poor'}`;
            
            feedbackContent.innerHTML = `
                <div class="feedback-message ${correction.correct ? 'success' : 'warning'}">
                    <p>${correction.feedback}</p>
                </div>
            `;
            
            if (correction.suggestions && correction.suggestions.length > 0) {
                const suggestionsHtml = correction.suggestions.map(suggestion => 
                    `<li>üí° ${suggestion}</li>`
                ).join('');
                
                feedbackSuggestions.innerHTML = `
                    <div class="suggestions-container">
                        <h4>üí≠ Dicas para Melhorar:</h4>
                        <ul>${suggestionsHtml}</ul>
                    </div>
                `;
            } else {
                feedbackSuggestions.innerHTML = '';
            }
        }

        // ============================================
        // Marcar aula como conclu√≠da
        // ============================================
        document.getElementById('complete-lesson-btn').addEventListener('click', async () => {
            const completeBtn = document.getElementById('complete-lesson-btn');
            const lessonNumber = getLessonNumber();
            
            try {
                completeBtn.textContent = '‚è≥ Salvando...';
                completeBtn.disabled = true;
                
                const userId = localStorage.getItem('userId');
                const userName = localStorage.getItem('userName');
                
                if (!userId) {
                    alert('Erro: Usu√°rio n√£o encontrado. Fa√ßa login novamente.');
                    window.location.href = '/';
                    return;
                }
                
                const response = await fetch('/api/complete-lesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lesson_number: lessonNumber,
                        user_id: userId,
                        module: getModuleName()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    completeBtn.textContent = '‚úÖ Aula Conclu√≠da!';
                    completeBtn.classList.add('completed');
                    
                    showSuccessMessage(`Parab√©ns! Aula ${lessonNumber} conclu√≠da. Progresso: ${result.total_completed}/10 aulas.`);
                    
                    setTimeout(() => {
                        const moduleName = getModuleName();
                        window.location.href = `/aulas/${moduleName}`;
                    }, 2000);
                    
                } else {
                    completeBtn.textContent = '‚ùå Erro ao salvar';
                    alert(`Erro ao salvar progresso: ${result.error}`);
                    setTimeout(() => {
                        completeBtn.textContent = '‚úÖ Marcar como Conclu√≠da';
                        completeBtn.disabled = false;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar aula como conclu√≠da:', error);
                completeBtn.textContent = '‚ùå Erro de conex√£o';
                alert(`Erro de conex√£o: ${error.message}`);
                setTimeout(() => {
                    completeBtn.textContent = '‚úÖ Marcar como Conclu√≠da';
                    completeBtn.disabled = false;
                }, 2000);
            }
        });

        // ============================================
        // Mostrar mensagem de sucesso
        // ============================================
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-notification';
            successDiv.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">üéâ</span>
                    <span class="success-text">${message}</span>
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }
        
        // ============================================
        // Fun√ß√µes auxiliares
        // ============================================
        
        function getExerciseDescription() {
            return document.querySelector('.exercise-description')?.textContent || 'Exerc√≠cio de programa√ß√£o Python';
        }
        
        function getLessonNumber() {
            const pathname = window.location.pathname;
            const match = pathname.match(/(\d+)/);
            return match ? parseInt(match[1]) : 1;
        }
        
        function getModuleName() {
            const pathname = window.location.pathname;
            if (pathname.includes('sequencial')) return 'sequencial';
            if (pathname.includes('comparativa')) return 'comparativa';
            if (pathname.includes('repetitiva')) return 'repetitiva';
            if (pathname.includes('vetores')) return 'vetores';
            if (pathname.includes('matrizes')) return 'matrizes';
            return 'sequencial';
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        function goToModuleLobby() {
            const moduleName = getModuleName();
            window.location.href = `/aulas/${moduleName}`;
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
